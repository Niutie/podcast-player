<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>派拉API网关产品部门培训</title>
  <meta name="description" content="企业培训播客：搜索、分类、当期内容、自定义音频播放器、往期回顾。" />
  <link rel="icon" href="/favicon.ico" />
  <!-- 优先拉取索引；若没有 index.json，会自动回退到 episodes.json -->
  <link rel="preload" href="/data/index.json" as="fetch">
  <link rel="preload" href="/data/episodes.json" as="fetch">
  <link rel="preconnect" href="/" crossorigin>
  <style>
    :root{ --bg:#f5f6f8;--surface:#ffffff;--ink:#0b1220;--muted:#6b7280;--line:#e6e8ee;--brand:#111827;--pill:#eef2f7;--pill-active:#111827;--pill-active-ink:#ffffff;--badge:#111827;--accent:#111827; --radius-xl:24px;--radius-lg:16px;--radius-md:12px;--shadow:0 4px 16px rgba(17,24,39,.08); --maxw:960px }
    *{box-sizing:border-box}
    html,body{height:100%; touch-action: pan-x pan-y; -ms-touch-action: manipulation; -webkit-text-size-adjust: 100%;}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--ink);background:var(--bg)}
    a{color:var(--accent);text-decoration:none}

    header{position:sticky;top:0;z-index:20;background:rgba(245,246,248,.9);backdrop-filter:saturate(1.2) blur(8px);border-bottom:1px solid var(--line)}
    .bar{max-width:var(--maxw);margin:0 auto;padding:14px 16px;text-align:center;font-weight:700}

    main{max-width:var(--maxw);margin:0 auto;padding:16px}

    /* 搜索 */
    .search-wrap{background:var(--surface);border:1px solid var(--line);border-radius:999px;padding:10px 14px;display:flex;gap:10px;align-items:center;box-shadow:var(--shadow)}
    .search-wrap input{border:none;outline:none;flex:1;font-size:16px;background:transparent}
    .search-icon{width:18px;height:18px;opacity:.6}

    /* 分类 chips */
    .filters{margin:14px 0 10px}
    .filter-title{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:14px;margin-bottom:8px}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{-webkit-appearance:none;appearance:none;border:1px solid var(--line);cursor:pointer;padding:8px 14px;border-radius:999px;background:var(--pill);color:#111827;font-weight:600;font-size:14px;transition:.2s ease;border-color:transparent}
    .chip:hover{transform:translateY(-1px)}
    .chip.active{background:var(--pill-active);color:var(--pill-active-ink);box-shadow:0 4px 10px rgba(17,24,39,.12)}

    /* 分段标题 */
    .section{margin:14px 0 10px;font-weight:800}

    /* 大卡片（本期内容） */
    .feature{background:var(--surface);border:1px solid var(--line);border-radius:var(--radius-xl);overflow:hidden;box-shadow:var(--shadow)}
    .feature .cover{position:relative}
    .feature .img{width:100%;aspect-ratio:16/9;object-fit:cover;display:block}
    .badge{position:absolute;left:12px;top:12px;background:var(--badge);color:#fff;border-radius:999px;padding:6px 10px;font-size:12px;font-weight:700}
    .tag{position:absolute;right:12px;top:12px;background:rgba(17,24,39,.85);color:#fff;border-radius:999px;padding:6px 10px;font-size:12px;font-weight:700}
    .pad{padding:14px}
    .title{margin:0 0 8px;font-size:18px;line-height:1.35}
    .meta{display:flex;gap:14px;align-items:center;color:var(--muted);font-size:14px;margin-bottom:10px}
    .desc{margin:0 0 12px;color:#374151;line-height:1.6}
    .skeleton{background:linear-gradient(90deg,#f1f3f7,#e8ecf5,#f1f3f7);background-size:200% 100%;animation:sk 1.2s ease-in-out infinite;border-radius:8px}
    .sk-line{height:12px;margin:6px 0}
    @keyframes sk{0%{background-position:0 0}100%{background-position:-200% 0}}

    /* 小卡片（往期） */
    .list{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:700px){.list{grid-template-columns:1fr 1fr}}
    .card{background:var(--surface);border:1px solid var(--line);border-radius:var(--radius-lg);overflow:hidden;box-shadow:var(--shadow);display:flex;flex-direction:column}
    .card .cover{position:relative}
    .card .img{width:100%;aspect-ratio:16/9;object-fit:cover;display:block}
    .card .pad{padding:12px}

    /* 自定义播放器 */
    .player{background:#fafbff;border:1px solid var(--line);border-radius:16px;padding:12px;box-shadow:0 6px 18px rgba(17,24,39,.06)}
    .controls{display:flex;justify-content:center;align-items:center;gap:14px;margin:10px 0}
    .btn{-webkit-appearance:none;appearance:none;display:inline-flex;align-items:center;justify-content:center;min-width:44px;height:40px;border:1px solid var(--line);background:linear-gradient(180deg,#fff,#f5f6fa);border-radius:12px;cursor:pointer;box-shadow:0 4px 12px rgba(17,24,39,.08);transition:.15s ease;padding:0 12px;font-weight:700}
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn:disabled{opacity:.5;cursor:default}
    .btn.primary{background:linear-gradient(180deg,#111827,#1f2937);color:#fff;border-color:#0f1625;box-shadow:0 10px 18px rgba(17,24,39,.25)}
    /* 加载中样式 */
    .btn.loading{pointer-events:none;opacity:.9}
    .btn.loading .ico-play,.btn.loading .ico-pause{display:none!important}
    .btn .spinner{display:none}
    .btn.loading .spinner{display:inline-block}
    .spinner{width:16px;height:16px;border-radius:50%;border:2px solid rgba(255,255,255,.35);border-top-color:#fff;animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .btn.rate{min-width:56px}
    .time{display:flex;justify-content:space-between;font-size:12px;color:var(--muted)}
    .range{width:100%;-webkit-appearance:none;appearance:none;background:linear-gradient(180deg,#e9edf6,#e1e6f2);height:8px;border-radius:999px;outline:none;border:1px solid var(--line)}
    .range::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:#ffffff;border:1px solid #d7dce6;box-shadow:0 2px 6px rgba(17,24,39,.16)}
    .range::-moz-range-thumb{width:18px;height:18px;border-radius:50%;background:#ffffff;border:1px solid #d7dce6;box-shadow:0 2px 6px rgba(17,24,39,.16)}

    .load{display:flex;justify-content:center;margin:16px 0}
    .load .btn{padding:10px 14px;border-radius:999px}

    footer{color:var(--muted);text-align:center;margin:22px 0 30px}
    .dock{position:fixed;left:0;right:0;bottom:0;background:var(--surface);border-top:1px solid var(--line);box-shadow:0 -8px 24px rgba(17,24,39,.08);padding:8px 12px;z-index:50}
    .dock [data-player]{max-width:var(--maxw);margin:0 auto}
  </style>
</head>
<body>
  <header>
    <div class="bar">派拉API网关产品部门培训</div>
  </header>

  <main>
    <!--（已按你的要求移除搜索与分类筛选）-->

    <div class="section">本期内容</div>
    <section id="feature"></section>

    <div class="section" style="display:flex;justify-content:space-between;align-items:center">
      <span>往期回顾</span>
      <small id="count" style="color:var(--muted)"></small>
    </div>
    <section id="list" class="list"></section>
    <div class="load"><button id="more" class="btn">加载更多</button></div>
  </main>
  <div id="dock" class="dock" hidden></div>
  <!-- 全局唯一音频内核（不移动 DOM） -->
  <audio id="core" preload="none" playsinline></audio>
  <footer>© <span id="year"></span> API网关培训播客</footer>

  <template id="cardTpl">
    <article class="card" data-id="">
      <div class="cover">
        <img class="img" alt="" loading="lazy" decoding="async" />
        <span class="tag" hidden></span>
      </div>
      <div class="pad">
        <h3 class="title"></h3>
        <div class="meta"></div>
        <p class="desc"></p>
        <div class="player" data-player><input class="range" type="range" min="0" max="100" value="0" step="0.1" aria-label="进度" oninput="window.__pp.seek(this)" />
          <div class="controls">
            <button class="btn" title="后退15秒" onclick="window.__pp.skip(this,-15)">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M11 19l-7-7 7-7"/><path d="M20 19l-7-7 7-7"/></svg>
            </button>
            <button class="btn primary" data-toggle title="播放/暂停" onclick="window.__pp.playPause(this)">
              <svg class="ico-play" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg>
              <svg class="ico-pause" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" style="display:none"><rect x="6" y="5" width="4" height="14" rx="1"/><rect x="14" y="5" width="4" height="14" rx="1"/></svg>
              <span class="spinner" aria-hidden="true"></span>
            </button>
            <button class="btn" title="快进30秒" onclick="window.__pp.skip(this,30)">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M13 5l7 7-7 7"/><path d="M4 5l7 7-7 7"/></svg>
            </button>
            <button class="btn rate" data-rate onclick="window.__pp.rate(this)">1x</button>
          </div>
          <div class="time"><span data-cur>00:00</span><span data-dur>--:--</span></div>
        </div>
      </div>
    </article>
  </template>

  <template id="featureTpl">
    <article class="feature" data-id="">
      <div class="cover">
        <img class="img" alt="" loading="eager" fetchpriority="high" />
        <span class="badge">最新期</span>
        <span class="tag" hidden></span>
      </div>
      <div class="pad">
        <h3 class="title"></h3>
        <div class="meta"></div>
        <p class="desc"></p>
        <div class="player" data-player><input class="range" type="range" min="0" max="100" value="0" step="0.1" aria-label="进度" oninput="window.__pp.seek(this)" />
          <div class="controls">
            <button class="btn" title="后退15秒" onclick="window.__pp.skip(this,-15)">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M11 19l-7-7 7-7"/><path d="M20 19l-7-7 7-7"/></svg>
            </button>
            <button class="btn primary" data-toggle title="播放/暂停" onclick="window.__pp.playPause(this)">
              <svg class="ico-play" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg>
              <svg class="ico-pause" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" style="display:none"><rect x="6" y="5" width="4" height="14" rx="1"/><rect x="14" y="5" width="4" height="14" rx="1"/></svg>
              <span class="spinner" aria-hidden="true"></span>
            </button>
            <button class="btn" title="快进30秒" onclick="window.__pp.skip(this,30)">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M13 5l7 7-7 7"/><path d="M4 5l7 7-7 7"/></svg>
            </button>
            <button class="btn rate" data-rate onclick="window.__pp.rate(this)">1x</button>
          </div>
          <div class="time"><span data-cur>00:00</span><span data-dur>--:--</span></div>
        </div>
      </div>
    </article>
  </template>

  <script>
  ;(() => {
    const INDEX_URL = '/data/index.json';       // 轻量索引（推荐）
    const FALLBACK_URL = '/data/episodes.json'; // 旧版全量
    const DETAILS_URL = id => `/data/episodes/${id}.json`; // 详情分片
    const PAGE_SIZE = 4;

    const el = sel => document.querySelector(sel);
    const feature = el('#feature');
    const list = el('#list');
    const more = el('#more');
    const chips = null;
    const q = null;
    const count = el('#count');
    const core = document.getElementById('core'); // 单实例全局音频
    el('#year').textContent = new Date().getFullYear();

    const S = { raw: [], filtered: [], page: 0, map: new Map(), details: new Map(), activeId: null, activeRoot: null, _rest: [] };
    const QP = new URLSearchParams(location.search);
    const PREVIEW = QP.has('preview');
    const PREFER = (QP.get('prefer') || 'mp3').toLowerCase(); // 默认优先 mp3，可用 ?prefer=m4a 覆盖

    const fmtDate = s => { if(!s) return ''; const d = new Date(s); if(Number.isNaN(d)) return s; return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; };
    const fmtDur = sec => { if(sec==null) return ''; const t = Math.max(0, Math.floor(sec)); const m = Math.floor(t/60), r = t%60; const h = Math.floor(m/60); const mm = m%60; return h>0? `${h}:${String(mm).padStart(2,'0')}:${String(r).padStart(2,'0')}` : `${mm}:${String(r).padStart(2,'0')}`; };

    function mimeFrom(url){ if(!url) return ''; const ext = url.split('.').pop().toLowerCase().split('?')[0]; if(ext==='m4a'||ext==='mp4'||ext==='aac') return 'audio/mp4'; if(ext==='mp3') return 'audio/mpeg'; if(ext==='wav') return 'audio/wav'; return ''; }

    function wireSources(audio, ep, eager=false){
      // 组装可用音频源（默认 mp3 优先，可 ?prefer=m4a 覆盖）
      let srcs = Array.isArray(ep.sources) ? ep.sources : (ep.audio ? [{src: ep.audio, type: mimeFrom(ep.audio)}] : []);
      const score = (s)=>{
        const url = s?.src || '';
        const t = (s?.type || mimeFrom(url) || '').toLowerCase();
        const isMp3 = /audio\/mpeg/.test(t) || /\.mp3(\?|$)/i.test(url);
        const isM4a = /audio\/mp4/.test(t)  || /\.(m4a|mp4)(\?|$)/i.test(url);
        if(PREFER==='m4a') return isM4a?0:(isMp3?1:2);
        return isMp3?0:(isM4a?1:2);
      };
      srcs = srcs.filter(Boolean).sort((a,b)=> score(a)-score(b));

      // 存在即写入 src 列表，优先 srcs[0]；同时保留 <source> 以便浏览器自行选择
      audio.innerHTML='';
      srcs.forEach(s=>{ if(!s||!s.src) return; const e=document.createElement('source'); e.src=s.src; const t=s.type||mimeFrom(s.src); if(t) e.type=t; audio.appendChild(e); });
      if (srcs.length>0) audio.setAttribute('src', srcs[0].src); else audio.removeAttribute('src');
      audio.setAttribute('playsinline','');

      // 记录到实例上，供错误/卡顿时自动切换
      audio._srcs = srcs.map(s=> s && s.src).filter(Boolean);
      audio._srcIdx = 0;

      if(eager){ try{ audio.load(); }catch(e){} }
    }

    // --- 全局播放器助手 ---
    window.__pp = {
      // 单实例下，每个卡片只需要把倍速文字初始化一下
      initOne(root){ const rateBtn = root.querySelector('[data-rate]'); if(rateBtn){ const v=(core.playbackRate.toFixed(1).replace(/\.0$/,''))+'x'; rateBtn.textContent=v; } },
      seek(input){ if(isFinite(core.duration)) core.currentTime=(input.value/100)*core.duration; },
      playPause(btn){
        const article = btn.closest('article'); const articleId = article?.dataset.id || null; const root = btn.closest('[data-player]');
        if(!articleId) return;
        const switching = (S.activeId !== articleId);
        const willPlay = switching || core.paused;
        S.activeRoot = root;
        if(willPlay){ root.classList.add('intent'); btn.classList.add('loading'); }
        const ep = S.map.get(articleId) || {};
        ensureSources(ep).then(()=>{
          if(switching){ wireSources(core, ep, false); S.activeId = articleId; }
          core.setAttribute('preload','metadata'); if(core.readyState < 3){ try{ core.load(); }catch(e){} }
          document.querySelectorAll('[data-player] .btn.primary').forEach(b=>{ if(b!==btn) b.classList.remove('loading'); });
          if(willPlay){
            const p = core.play();
            if(p && p.then){ p.then(()=>{ btn.classList.remove('loading'); root.classList.remove('intent'); }).catch(()=>{ btn.classList.remove('loading'); root.classList.remove('intent'); }); }
          }else{
            core.pause(); btn.classList.remove('loading'); root.classList.remove('intent');
          }
        });
      },
      skip(btn, d){ core.currentTime=Math.max(0, Math.min((core.currentTime||0)+d, core.duration||Infinity)); },
      rate(btn){ const steps=[1,1.2,1.5]; const cur=parseFloat(core.playbackRate.toFixed(1)); const i=Math.max(0, steps.indexOf(cur)); const next=steps[(i+1)%steps.length]; core.playbackRate=next; btn.textContent=(next.toString().replace(/\.0$/,''))+'x'; if(S.activeRoot && S.activeRoot!==btn.closest('[data-player]')){ const r=S.activeRoot.querySelector('[data-rate]'); if(r) r.textContent=btn.textContent; } }
    };

    function buildChips(){}

    function apply(){
      const now = Date.now();
      const isVisible = (e)=>{
        if (PREVIEW) return true;
        if (e == null) return false;
        if (e.published === false || e.visible === false) return false;
        if (e.status === 'draft') return false;
        const pub = new Date(e.publishAt || e.date || 0).getTime();
        if (e.publishAt && isFinite(pub) && now < pub) return false;
        const exp = e.expireAt ? new Date(e.expireAt).getTime() : Infinity;
        if (e.expireAt && isFinite(exp) && now >= exp) return false;
        return true;
      };
      S.filtered = S.raw.filter(isVisible);
      const pin = (e)=> (e?.featured===true) || (e?.pinnedUntil && (now < new Date(e.pinnedUntil).getTime())) ? 1 : 0;
      const pubTime = (e)=> new Date(e.publishAt || e.date || 0).getTime();
      S.filtered.sort((a,b)=> pin(b)-pin(a) || pubTime(b)-pubTime(a));
      S.page = 0;
      render();
    }

    function render(){
      feature.innerHTML=''; list.innerHTML='';
      const total=S.filtered.length; if(total===0){ count.textContent='显示 0/0 期'; more.disabled=true; return; }
      const first=S.filtered[0]; feature.appendChild(renderFeature(first));
      const rest=S.filtered.slice(1); S._rest=rest;
      count.textContent=`显示 ${Math.min(S.page*PAGE_SIZE + Math.min(PAGE_SIZE, rest.length), rest.length)}/${rest.length} 期`;
      more.disabled=rest.length===0; S.page=0; loadMore();
      observePlayers();
      syncActiveUI();
    }

    function ensureDetail(ep){
      // 若已拥有描述/音频则不再请求
      if(ep && ep.description && (ep.audio || ep.sources)) return Promise.resolve(ep);
      if(!ep || !ep.id) return Promise.resolve(ep);
      if(S.details.has(ep.id)) return S.details.get(ep.id);
      const p = fetch(DETAILS_URL(ep.id), {cache:'no-store'}).then(r=> r.ok? r.json(): {} ).then(d=>{
        Object.assign(ep, d);
        return ep;
      }).catch(()=>ep);
      S.details.set(ep.id, p);
      return p;
    }
    // 确保有可用音频源：无详情则拉详情，仍无则探测 /episodes/{id}/audio.(mp3|m4a)
    async function ensureSources(ep){
      if(!ep) return ep;
      // helper: 探测并校验为音频
      async function probe(u){
        try{
          const r = await fetch(u, { method:'HEAD', cache:'no-store' });
          if(!r.ok) return false;
          const ct = (r.headers.get('content-type')||'').toLowerCase();
          return ct.startsWith('audio/');
        }catch{ return false; }
      }
      // 已有 sources：校验一遍，过滤非音频/错指向（例如被 SPA 200 成 index.html）
      if(Array.isArray(ep.sources) && ep.sources.length){
        const checked = [];
        for(const s of ep.sources){ if(s && s.src && await probe(s.src)) checked.push({src:s.src, type:(s.type||mimeFrom(s.src))}); }
        ep.sources = checked;
        if(checked.length) return ep;
      }
      // 没有 sources，拉详情
      if(!ep.audio){ await ensureDetail(ep); }
      if(Array.isArray(ep.sources) && ep.sources.length) return ep;
      if(ep.audio && await probe(ep.audio)) return ep;
      // 兜底：按 prefer 顺序探测常规路径
      if(!ep.id) return ep;
      const mp3 = `/episodes/${ep.id}/audio.mp3`;
      const m4a = `/episodes/${ep.id}/audio.m4a`;
      const order = (PREFER==='m4a') ? [m4a, mp3] : [mp3, m4a];
      const list = [];
      for(const u of order){ if(await probe(u)) list.push({src:u, type:mimeFrom(u)}); }
      if(list.length){ ep.sources = list; }
      return ep;
    }

    function renderFeature(ep){
      const t=document.getElementById('featureTpl'); const node=t.content.cloneNode(true);
      const article=node.querySelector('article.feature'); const img=node.querySelector('.img'); const tag=node.querySelector('.tag'); const title=node.querySelector('.title'); const meta=node.querySelector('.meta'); const desc=node.querySelector('.desc'); const player=node.querySelector('[data-player]');
      if(article) article.dataset.id=ep.id||''; img.src=ep.cover||''; img.alt=ep.title||''; if(ep.tags&&ep.tags[0]){ tag.hidden=false; tag.textContent=ep.tags[0]; }
      title.textContent=ep.title||'未命名节目'; const date=fmtDate(ep.date); const dur=fmtDur(ep.duration); meta.textContent=`${date?date:''}${date&&dur?' · ':''}${dur?dur:''}`;
      if(ep.description){ desc.textContent=ep.description; } else { desc.innerHTML = '<div class="skeleton sk-line" style="width:90%"></div><div class="skeleton sk-line" style="width:95%"></div><div class="skeleton sk-line" style="width:80%"></div>'; }
      // 仅做首屏预热：挑选首选音源，添加 preload link；不改动核心音频
      const pick=(arr)=>{ if(!arr||!arr.length) return null; const score=s=>{ const u=s?.src||''; const t=(s?.type||mimeFrom(u)||'').toLowerCase(); const mp3=/audio\/mpeg/.test(t)||/\.mp3(\?|$)/i.test(u); const m4a=/audio\/mp4/.test(t)||/\.(m4a|mp4)(\?|$)/i.test(u); if(PREFER==='m4a') return m4a?0:(mp3?1:2); return mp3?0:(m4a?1:2); }; const list=arr.slice().sort((a,b)=>score(a)-score(b)); return list[0]; };
      const best = pick(ep.sources||[]) || (ep.audio? {src:ep.audio, type:mimeFrom(ep.audio)}: null);
      if(best&&best.src){ const l=document.createElement('link'); l.rel='preload'; l.as='audio'; l.href=best.src; document.head.appendChild(l); }
      window.__pp.initOne(player);
      // 缺详情，异步补齐
      ensureDetail(ep).then(()=>{ if(ep.description) desc.textContent = ep.description; });
      return node;
    }

    function renderCard(ep){
      const t=document.getElementById('cardTpl'); const node=t.content.cloneNode(true);
      const article=node.querySelector('article.card'); const img=node.querySelector('.img'); const tag=node.querySelector('.tag'); const title=node.querySelector('.title'); const meta=node.querySelector('.meta'); const desc=node.querySelector('.desc'); const player=node.querySelector('[data-player]');
      if(article) article.dataset.id=ep.id||''; img.src=ep.cover||''; img.alt=ep.title||''; if(ep.tags&&ep.tags[0]){ tag.hidden=false; tag.textContent=ep.tags[0]; }
      title.textContent=ep.title||'未命名节目'; const date=fmtDate(ep.date); const dur=fmtDur(ep.duration); meta.textContent=`${date?date:''}${date&&dur?' · ':''}${dur?dur:''}`;
      if(ep.description){ desc.textContent=ep.description; } else { desc.innerHTML = '<div class="skeleton sk-line" style="width:88%"></div><div class="skeleton sk-line" style="width:92%"></div>'; }
      window.__pp.initOne(player);
      // 进入视口再取详情
      article._hydrate = ()=> ensureDetail(ep).then(()=>{ if(ep.description) desc.textContent = ep.description; });
      return node;
    }

    function loadMore(){
      const start=S.page*PAGE_SIZE; const end=Math.min(start+PAGE_SIZE, S._rest.length);
      const items=S._rest.slice(start,end); const nodes = items.map(ep=> renderCard(ep)); nodes.forEach(n=>list.appendChild(n)); S.page++;
      count.textContent=`显示 ${Math.min(end, S._rest.length)}/${S._rest.length} 期`;
      if(end>=S._rest.length){ more.disabled=true; more.textContent='没有更多了'; } else { more.disabled=false; more.textContent='加载更多'; }
      observePlayers();
      syncActiveUI();
    }

    async function getIndex(){
      // 优先 index.json，失败回退 episodes.json
      try{
        const r = await fetch(INDEX_URL, {cache:'no-store'});
        if(r.ok){ const j = await r.json(); return Array.isArray(j.episodes)? j.episodes : []; }
      }catch{}
      try{
        const r = await fetch(FALLBACK_URL, {cache:'no-store'});
        if(r.ok){ const j = await r.json(); return Array.isArray(j.episodes)? j.episodes : []; }
      }catch{}
      return [];
    }

    async function init(){
      try{
        const eps = await getIndex();
        S.raw = eps;
        // 建立索引
        S.map.clear(); eps.forEach(e=> S.map.set(e.id, e));// 已移除分类，不需要 buildChips()
        apply();
      }catch(e){ console.error(e); }
    }

    more.addEventListener('click', loadMore);
    // 搜索已移除，不绑定监听 });

    // 单实例模式：不再移动 DOM 到 dock，仅保留占位容器以备将来做迷你控制条
    const dock=document.getElementById('dock'); dock.hidden=true; window.__dockOps = { hideIfIdle: ()=>{}, reattach: ()=>null };

    init();

    // 懒加载：卡片进入视口附近才加载音频元数据 & 详情
    let io;
    function observePlayers(){
      if(!('IntersectionObserver' in window)) return;
      if(!io){ io = new IntersectionObserver((entries)=>{ entries.forEach(entry=>{ if(entry.isIntersecting){ const article = entry.target; io.unobserve(article); if(typeof article._hydrate === 'function'){ article._hydrate(); } } }); }, { rootMargin: '200px 0px', threshold: 0.01 }); }
      document.querySelectorAll('article.card').forEach(p=>{ if(!p._obs){ io.observe(p); p._obs=true; } });
    }
    // 同步当前播放 UI（在重渲染或分页后调用）
    function syncActiveUI(){
      if(!S.activeId) return;
      const host = document.querySelector(`[data-id="${S.activeId}"] [data-player]`);
      if(host){ S.activeRoot = host; }
      const r = S.activeRoot; if(!r) return;
      const cur=r.querySelector('[data-cur]'); const dur=r.querySelector('[data-dur]'); const range=r.querySelector('.range'); const play=r.querySelector('[data-toggle]'); const iconPlay=r.querySelector('.ico-play'); const iconPause=r.querySelector('.ico-pause'); const rate=r.querySelector('[data-rate]');
      const toTime = t=>{const s=Math.floor(t||0); const m=Math.floor(s/60), x=s%60; return `${String(m).padStart(2,'0')}:${String(x).padStart(2,'0')}`};
      if(dur) dur.textContent = isFinite(core.duration)? toTime(core.duration): '--:--';
      if(cur) cur.textContent = toTime(core.currentTime||0);
      if(range && isFinite(core.duration)) range.value = (core.currentTime/core.duration)*100 || 0;
      if(rate) rate.textContent = (core.playbackRate.toFixed(1).replace(/\.0$/,''))+'x';
      const playing = !core.paused;
      if(iconPlay) iconPlay.style.display = playing?'none':'block';
      if(iconPause) iconPause.style.display = playing?'block':'none';
      if(play) play.classList.remove('loading');
      if(r) r.classList.remove('intent');
    }

    // 绑定全局内核事件（只绑定一次）
    (function bindCore(){
      const toTime = t=>{const s=Math.floor(t||0); const m=Math.floor(s/60), r=s%60; return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`};
      let lastProgress = Date.now();
      let stallTimer = null;
      function ui(){
        const r = S.activeRoot;
        if(!r) return {cur:null,dur:null,range:null,btn:null,iconPlay:null,iconPause:null};
        return {
          cur: r.querySelector('[data-cur]'),
          dur: r.querySelector('[data-dur]'),
          range: r.querySelector('.range'),
          btn: r.querySelector('[data-toggle]'),
          iconPlay: r.querySelector('.ico-play'),
          iconPause: r.querySelector('.ico-pause')
        };
      }
      function markIdle(){
        const u = ui();
        if(u.btn) u.btn.classList.remove('loading');
        if(S.activeRoot) S.activeRoot.classList.remove('intent');
      }

      core.addEventListener('loadedmetadata', ()=>{
        const u = ui();
        if(u.dur) u.dur.textContent = toTime(core.duration||0);
      });
      core.addEventListener('loadeddata', ()=>{ markIdle(); });
      core.addEventListener('canplay', ()=>{ markIdle(); });
      core.addEventListener('canplaythrough', ()=>{ markIdle(); });

      core.addEventListener('timeupdate', ()=>{
        lastProgress = Date.now();
        const u = ui();
        if(u.range && isFinite(core.duration)){
          u.range.value = (core.currentTime/core.duration)*100 || 0;
        }
        if(u.cur){ u.cur.textContent = toTime(core.currentTime||0); }
        if(u.btn && u.btn.classList.contains('loading')){ u.btn.classList.remove('loading'); }
        if(S.activeRoot){ S.activeRoot.classList.remove('intent'); }
      });

      core.addEventListener('play', ()=>{
        const u = ui();
        if(u.iconPlay) u.iconPlay.style.display='none';
        if(u.iconPause) u.iconPause.style.display='block';
        markIdle();
      });
      core.addEventListener('pause', ()=>{
        const u = ui();
        if(u.iconPlay) u.iconPlay.style.display='block';
        if(u.iconPause) u.iconPause.style.display='none';
        markIdle();
      });
      core.addEventListener('ended', ()=>{ markIdle(); });

      // 卡顿自愈 + 源切换
      function nextSrc(){
        const list = Array.isArray(core._srcs) ? core._srcs : [];
        let idx = (core._srcIdx||0) + 1;
        if(idx < list.length){
          core._srcIdx = idx;
          core.src = list[idx];
          try{ core.load(); const p = core.play(); if(p&&p.catch) p.catch(()=>{}); }catch(e){}
        } else {
          const u = ui(); if(u && u.btn) u.btn.classList.remove('loading');
          if(S.activeRoot) S.activeRoot.classList.remove('intent');
        }
      }
      function kick(){
        try{
          if(core.readyState < 3) core.load();
          if(isFinite(core.duration) && (core.currentTime < (core.duration - 0.05))){
            core.currentTime = Math.max(0, (core.currentTime||0) + 0.01);
          }
          const p = core.play(); if(p && p.catch) p.catch(()=>{});
        }catch(e){}
      }
      core.addEventListener('waiting', ()=>{
        clearTimeout(stallTimer);
        const u = ui(); if(u.btn) u.btn.classList.add('loading');
        stallTimer = setTimeout(()=>{ (Date.now()-lastProgress>1500) ? nextSrc() : kick(); }, 900);
      });
      core.addEventListener('stalled', ()=>{
        clearTimeout(stallTimer);
        const u = ui(); if(u.btn) u.btn.classList.add('loading');
        stallTimer = setTimeout(()=>{ (Date.now()-lastProgress>1500) ? nextSrc() : kick(); }, 900);
      });
      core.addEventListener('error', ()=>{ clearTimeout(stallTimer); nextSrc(); });
    })();
  })();
  </script>
<script>
// 关闭双指缩放 / 双击放大（移动端 WebView 兼容）
(function(){
  const opt = { passive: false };
  // 多指触控（pinch）直接拦截
  document.addEventListener('touchstart', function(e){ if(e.touches.length > 1){ e.preventDefault(); } }, opt);
  // iOS Safari 专有手势事件
  document.addEventListener('gesturestart', function(e){ e.preventDefault(); }, opt);
  document.addEventListener('gesturechange', function(e){ e.preventDefault(); }, opt);
  document.addEventListener('gestureend', function(e){ e.preventDefault(); }, opt);
  // 双击放大拦截
  let last = 0;
  document.addEventListener('touchend', function(e){ const now = Date.now(); if(now - last < 300){ e.preventDefault(); } last = now; }, opt);
  // 桌面端 Ctrl+滚轮缩放
  document.addEventListener('wheel', function(e){ if(e.ctrlKey){ e.preventDefault(); } }, opt);
})();
</script>
</body>
</html>
