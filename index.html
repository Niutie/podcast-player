<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>派拉API网关产品部门培训</title>
  <meta name="description" content="企业培训播客：搜索、分类、当期内容、自定义音频播放器、往期回顾。" />
  <link rel="icon" href="/favicon.ico" />
  <link rel="preload" href="/data/episodes.json" as="fetch">
  <link rel="preconnect" href="/" crossorigin>
  <style>
    :root{ --bg:#f5f6f8;--surface:#ffffff;--ink:#0b1220;--muted:#6b7280;--line:#e6e8ee;--brand:#111827;--pill:#eef2f7;--pill-active:#111827;--pill-active-ink:#ffffff;--badge:#111827;--accent:#111827; --radius-xl:24px;--radius-lg:16px;--radius-md:12px;--shadow:0 4px 16px rgba(17,24,39,.08); --maxw:960px }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--ink);background:var(--bg)}
    a{color:var(--accent);text-decoration:none}

    header{position:sticky;top:0;z-index:20;background:rgba(245,246,248,.9);backdrop-filter:saturate(1.2) blur(8px);border-bottom:1px solid var(--line)}
    .bar{max-width:var(--maxw);margin:0 auto;padding:14px 16px;text-align:center;font-weight:700}

    main{max-width:var(--maxw);margin:0 auto;padding:16px}

    /* 搜索 */
    .search-wrap{background:var(--surface);border:1px solid var(--line);border-radius:999px;padding:10px 14px;display:flex;gap:10px;align-items:center;box-shadow:var(--shadow)}
    .search-wrap input{border:none;outline:none;flex:1;font-size:16px;background:transparent}
    .search-icon{width:18px;height:18px;opacity:.6}

    /* 分类 chips */
    .filters{margin:14px 0 10px}
    .filter-title{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:14px;margin-bottom:8px}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{appearance:none;border:1px solid var(--line);cursor:pointer;padding:8px 14px;border-radius:999px;background:var(--pill);color:#111827;font-weight:600;font-size:14px;transition:.2s ease;border-color:transparent}
    .chip:hover{transform:translateY(-1px)}
    .chip.active{background:var(--pill-active);color:var(--pill-active-ink);box-shadow:0 4px 10px rgba(17,24,39,.12)}

    /* 分段标题 */
    .section{margin:14px 0 10px;font-weight:800}

    /* 大卡片（本期内容） */
    .feature{background:var(--surface);border:1px solid var(--line);border-radius:var(--radius-xl);overflow:hidden;box-shadow:var(--shadow)}
    .feature .cover{position:relative}
    .feature .img{width:100%;aspect-ratio:16/9;object-fit:cover;display:block}
    .badge{position:absolute;left:12px;top:12px;background:var(--badge);color:#fff;border-radius:999px;padding:6px 10px;font-size:12px;font-weight:700}
    .tag{position:absolute;right:12px;top:12px;background:rgba(17,24,39,.85);color:#fff;border-radius:999px;padding:6px 10px;font-size:12px;font-weight:700}
    .pad{padding:14px}
    .title{margin:0 0 8px;font-size:18px;line-height:1.35}
    .meta{display:flex;gap:14px;align-items:center;color:var(--muted);font-size:14px;margin-bottom:10px}
    .desc{margin:0 0 12px;color:#374151;line-height:1.6}

    /* 小卡片（往期） */
    .list{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:700px){.list{grid-template-columns:1fr 1fr}}
    .card{background:var(--surface);border:1px solid var(--line);border-radius:var(--radius-lg);overflow:hidden;box-shadow:var(--shadow);display:flex;flex-direction:column}
    .card .cover{position:relative}
    .card .img{width:100%;aspect-ratio:16/9;object-fit:cover;display:block}
    .card .pad{padding:12px}

    /* 自定义播放器 */
    .player{background:#fafbff;border:1px solid var(--line);border-radius:16px;padding:12px;box-shadow:0 6px 18px rgba(17,24,39,.06)}
    .controls{display:flex;justify-content:center;align-items:center;gap:14px;margin:10px 0}
    .btn{appearance:none;display:inline-flex;align-items:center;justify-content:center;min-width:44px;height:40px;border:1px solid var(--line);background:linear-gradient(180deg,#fff,#f5f6fa);border-radius:12px;cursor:pointer;box-shadow:0 4px 12px rgba(17,24,39,.08);transition:.15s ease;padding:0 12px;font-weight:700}
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn:disabled{opacity:.5;cursor:default}
    .btn.primary{background:linear-gradient(180deg,#111827,#1f2937);color:#fff;border-color:#0f1625;box-shadow:0 10px 18px rgba(17,24,39,.25)}
    /* 加载中样式 */
    .btn.loading{pointer-events:none;opacity:.9}
    .btn.loading .ico-play,.btn.loading .ico-pause{display:none!important}
    .btn .spinner{display:none}
    .btn.loading .spinner{display:inline-block}
    .spinner{width:16px;height:16px;border-radius:50%;border:2px solid rgba(255,255,255,.35);border-top-color:#fff;animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .btn.rate{min-width:56px}
    .time{display:flex;justify-content:space-between;font-size:12px;color:var(--muted)}
    .range{width:100%;-webkit-appearance:none;background:linear-gradient(180deg,#e9edf6,#e1e6f2);height:8px;border-radius:999px;outline:none;border:1px solid var(--line)}
    .range::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:#ffffff;border:1px solid #d7dce6;box-shadow:0 2px 6px rgba(17,24,39,.16)}
    .range::-moz-range-thumb{width:18px;height:18px;border-radius:50%;background:#ffffff;border:1px solid #d7dce6;box-shadow:0 2px 6px rgba(17,24,39,.16)}

    .load{display:flex;justify-content:center;margin:16px 0}
    .load .btn{padding:10px 14px;border-radius:999px}

    footer{color:var(--muted);text-align:center;margin:22px 0 30px}
    .dock{position:fixed;left:0;right:0;bottom:0;background:var(--surface);border-top:1px solid var(--line);box-shadow:0 -8px 24px rgba(17,24,39,.08);padding:8px 12px;z-index:50}
    .dock [data-player]{max-width:var(--maxw);margin:0 auto}
  </style>
</head>
<body>
  <header>
    <div class="bar">派拉API网关产品部门培训</div>
  </header>

  <main>
    <!-- 搜索 -->
    <div class="search-wrap" role="search">
      <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
      <input id="q" type="search" placeholder="搜索播客内容…" aria-label="搜索播客" />
    </div>

    <!-- 分类 -->
    <div class="filters">
      <div class="filter-title">🧭 分类筛选</div>
      <div id="chips" class="chips"></div>
    </div>

    <div class="section">本期内容</div>
    <section id="feature"></section>

    <div class="section" style="display:flex;justify-content:space-between;align-items:center">
      <span>往期回顾</span>
      <small id="count" style="color:var(--muted)"></small>
    </div>
    <section id="list" class="list"></section>
    <div class="load"><button id="more" class="btn">加载更多</button></div>
  </main>
  <div id="dock" class="dock" hidden></div>
  <footer>© <span id="year"></span> API网关培训播客</footer>

  <template id="cardTpl">
    <article class="card">
      <div class="cover">
        <img class="img" alt="" loading="lazy" decoding="async" />
        <span class="tag" hidden></span>
      </div>
      <div class="pad">
        <h3 class="title"></h3>
        <div class="meta"></div>
        <p class="desc"></p>
        <div class="player" data-player>
          <audio preload="metadata"></audio>
          <input class="range" type="range" min="0" max="100" value="0" step="0.1" aria-label="进度" oninput="window.__pp.seek(this)" />
          <div class="controls">
            <button class="btn" title="后退15秒" onclick="window.__pp.skip(this,-15)">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M11 19l-7-7 7-7"/><path d="M20 19l-7-7 7-7"/></svg>
            </button>
            <button class="btn primary" data-toggle title="播放/暂停" onclick="window.__pp.playPause(this)">
              <svg class="ico-play" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg>
              <svg class="ico-pause" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" style="display:none"><rect x="6" y="5" width="4" height="14" rx="1"/><rect x="14" y="5" width="4" height="14" rx="1"/></svg>
              <span class="spinner" aria-hidden="true"></span>
            </button>
            <button class="btn" title="快进30秒" onclick="window.__pp.skip(this,30)">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M13 5l7 7-7 7"/><path d="M4 5l7 7-7 7"/></svg>
            </button>
            <button class="btn rate" data-rate onclick="window.__pp.rate(this)">1x</button>
          </div>
          <div class="time"><span data-cur>00:00</span><span data-dur>--:--</span></div>
        </div>
      </div>
    </article>
  </template>

  <template id="featureTpl">
    <article class="feature">
      <div class="cover">
        <img class="img" alt="" loading="eager" fetchpriority="high" />
        <span class="badge">最新期</span>
        <span class="tag" hidden></span>
      </div>
      <div class="pad">
        <h3 class="title"></h3>
        <div class="meta"></div>
        <p class="desc"></p>
        <div class="player" data-player>
          <audio preload="metadata"></audio>
          <input class="range" type="range" min="0" max="100" value="0" step="0.1" aria-label="进度" oninput="window.__pp.seek(this)" />
          <div class="controls">
            <button class="btn" title="后退15秒" onclick="window.__pp.skip(this,-15)">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M11 19l-7-7 7-7"/><path d="M20 19l-7-7 7-7"/></svg>
            </button>
            <button class="btn primary" data-toggle title="播放/暂停" onclick="window.__pp.playPause(this)">
              <svg class="ico-play" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg>
              <svg class="ico-pause" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" style="display:none"><rect x="6" y="5" width="4" height="14" rx="1"/><rect x="14" y="5" width="4" height="14" rx="1"/></svg>
              <span class="spinner" aria-hidden="true"></span>
            </button>
            <button class="btn" title="快进30秒" onclick="window.__pp.skip(this,30)">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M13 5l7 7-7 7"/><path d="M4 5l7 7-7 7"/></svg>
            </button>
            <button class="btn rate" data-rate onclick="window.__pp.rate(this)">1x</button>
          </div>
          <div class="time"><span data-cur>00:00</span><span data-dur>--:--</span></div>
        </div>
      </div>
    </article>
  </template>

  <script>
  ;(() => {
    const DATA = '/data/episodes.json';
    const PAGE_SIZE = 4;

    const el = sel => document.querySelector(sel);
    const feature = el('#feature');
    const list = el('#list');
    const more = el('#more');
    const chips = el('#chips');
    const q = el('#q');
    const count = el('#count');
    el('#year').textContent = new Date().getFullYear();

    const S = { raw: [], filtered: [], page: 0, tag: '全部', q: '' };

    const fmtDate = s => { if(!s) return ''; const d = new Date(s); if(Number.isNaN(d)) return s; return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; };
    const fmtDur = sec => { if(sec==null) return ''; const t = Math.max(0, Math.floor(sec)); const m = Math.floor(t/60), r = t%60; const h = Math.floor(m/60); const mm = m%60; return h>0? `${h}:${String(mm).padStart(2,'0')}:${String(r).padStart(2,'0')}` : `${mm}:${String(r).padStart(2,'0')}`; };

    function mimeFrom(url){ if(!url) return ''; const ext = url.split('.').pop().toLowerCase().split('?')[0]; if(ext==='m4a'||ext==='mp4'||ext==='aac') return 'audio/mp4'; if(ext==='mp3') return 'audio/mpeg'; if(ext==='wav') return 'audio/wav'; return ''; }
    function wireSources(audio, ep){ audio.innerHTML=''; const srcs = Array.isArray(ep.sources) ? ep.sources : (ep.audio ? [{src: ep.audio, type: mimeFrom(ep.audio)}] : []); srcs.forEach(s=>{ if(!s||!s.src) return; const e=document.createElement('source'); e.src=s.src; const t=s.type||mimeFrom(s.src); if(t) e.type=t; audio.appendChild(e); }); audio.removeAttribute('src'); audio.load(); }

    // --- 全局播放器助手 ---
    window.__pp = {
      initOne(root){
        const audio = root.querySelector('audio');
        const range = root.querySelector('.range');
        const cur = root.querySelector('[data-cur]');
        const dur = root.querySelector('[data-dur]');
        const playBtn = root.querySelector('[data-toggle]');
        const iconPlay = playBtn.querySelector('.ico-play');
        const iconPause = playBtn.querySelector('.ico-pause');
        const rateBtn = root.querySelector('[data-rate]');
        const toTime = t=>{const s=Math.floor(t); const m=Math.floor(s/60), r=s%60; return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`};

        const setLoading = (on)=>{ playBtn.classList.toggle('loading', !!on); };
        audio.addEventListener('loadstart', ()=> setLoading(true));
        audio.addEventListener('waiting',   ()=> setLoading(true));
        audio.addEventListener('stalled',   ()=> setLoading(true));
        audio.addEventListener('canplay',   ()=> setLoading(false));
        audio.addEventListener('playing',   ()=> setLoading(false));

        audio.addEventListener('loadedmetadata', ()=>{ dur.textContent = toTime(audio.duration||0); });
        audio.addEventListener('timeupdate', ()=>{ if(!isFinite(audio.duration)) return; const p=(audio.currentTime/audio.duration)*100; range.value=p||0; cur.textContent=toTime(audio.currentTime); });
        audio.addEventListener('play', ()=>{ iconPlay.style.display='none'; iconPause.style.display='block'; });
        audio.addEventListener('pause',()=>{ iconPlay.style.display='block'; iconPause.style.display='none'; });
        if(rateBtn){ rateBtn.textContent=(audio.playbackRate.toFixed(1).replace(/\.0$/, ''))+'x'; }
      },
      seek(input){ const root=input.closest('[data-player]'); const audio=root.querySelector('audio'); if(isFinite(audio.duration)) audio.currentTime=(input.value/100)*audio.duration; },
      playPause(btn){ const root=btn.closest('[data-player]'); const audio=root.querySelector('audio'); const setLoading=(on)=> btn.classList.toggle('loading', !!on); if(audio.readyState<3){ try{ setLoading(true); audio.load(); }catch(e){} } document.querySelectorAll('audio').forEach(a=>{ if(a!==audio) a.pause(); }); const p=audio.paused?audio.play():audio.pause(); if(p&&p.catch){ p.catch(()=> setLoading(false)); } },
      skip(btn, d){ const root=btn.closest('[data-player]'); const audio=root.querySelector('audio'); audio.currentTime=Math.max(0, Math.min((audio.currentTime||0)+d, audio.duration||Infinity)); },
      rate(btn){ const root=btn.closest('[data-player]'); const audio=root.querySelector('audio'); const steps=[1,1.2,1.5]; const cur=parseFloat(audio.playbackRate.toFixed(1)); const i=Math.max(0, steps.indexOf(cur)); const next=steps[(i+1)%steps.length]; audio.playbackRate=next; btn.textContent=(next.toString().replace(/\.0$/, ''))+'x'; }
    };

    function buildChips(){
      const set = new Set(); (S.raw||[]).forEach(e => (e.tags||[]).forEach(t => set.add(t)));
      const ordered = ['全部', ...Array.from(set)];
      chips.innerHTML = ordered.map(name => `<button class="chip${name===S.tag?' active':''}" data-tag="${name}">${name}</button>`).join('');
      chips.onclick = (ev)=>{ const btn=ev.target.closest('.chip'); if(!btn) return; const t=btn.dataset.tag; if(!t||t===S.tag) return; S.tag=t; chips.querySelectorAll('.chip').forEach(c=>c.classList.toggle('active', c.dataset.tag===S.tag)); apply(); };
    }

    function apply(){
      const qtext = S.q.trim().toLowerCase();
      S.filtered = S.raw.filter(e => { const okTag=(S.tag==='全部')||(e.tags||[]).includes(S.tag); const inText=!qtext || [e.title,e.description,...(e.tags||[])].join(' ').toLowerCase().includes(qtext); return okTag && inText; });
      S.filtered.sort((a,b)=> new Date(b.date||0) - new Date(a.date||0));
      S.page = 0; render();
    }

    function render(){
      preserveIfPlaying();
      feature.innerHTML=''; list.innerHTML='';
      const total=S.filtered.length; if(total===0){ count.textContent='显示 0/0 期'; more.disabled=true; return; }
      const first=S.filtered[0]; feature.appendChild(renderFeature(first));
      const rest=S.filtered.slice(1); S._rest=rest;
      count.textContent=`显示 ${Math.min(S.page*PAGE_SIZE + Math.min(PAGE_SIZE, rest.length), rest.length)}/${rest.length} 期`;
      more.disabled=rest.length===0; S.page=0; loadMore();
      tryAttachBack();
    }

    function renderFeature(ep){
      const t=document.getElementById('featureTpl'); const node=t.content.cloneNode(true);
      const article=node.querySelector('article.feature'); const img=node.querySelector('.img'); const tag=node.querySelector('.tag'); const title=node.querySelector('.title'); const meta=node.querySelector('.meta'); const desc=node.querySelector('.desc'); const audio=node.querySelector('audio'); const player=node.querySelector('[data-player]');
      if(article) article.dataset.id=ep.id||''; img.src=ep.cover||''; img.alt=ep.title||''; if(ep.tags&&ep.tags[0]){ tag.hidden=false; tag.textContent=ep.tags[0]; }
      title.textContent=ep.title||'未命名节目'; const date=fmtDate(ep.date); const dur=fmtDur(ep.duration); meta.textContent=`${date?date:''}${date&&dur?' · ':''}${dur?dur:''}`; desc.textContent=ep.description||'';
      wireSources(audio, ep);
      // 首屏节目：允许浏览器提前拉取一点数据
      audio.setAttribute('preload','auto');
      audio.load(); window.__pp.initOne(player); return node;
    }

    function renderCard(ep){
      const t=document.getElementById('cardTpl'); const node=t.content.cloneNode(true);
      const article=node.querySelector('article.card'); const img=node.querySelector('.img'); const tag=node.querySelector('.tag'); const title=node.querySelector('.title'); const meta=node.querySelector('.meta'); const desc=node.querySelector('.desc'); const audio=node.querySelector('audio'); const player=node.querySelector('[data-player]');
      if(article) article.dataset.id=ep.id||''; img.src=ep.cover||''; img.alt=ep.title||''; if(ep.tags&&ep.tags[0]){ tag.hidden=false; tag.textContent=ep.tags[0]; }
      title.textContent=ep.title||'未命名节目'; const date=fmtDate(ep.date); const dur=fmtDur(ep.duration); meta.textContent=`${date?date:''}${date&&dur?' · ':''}${dur?dur:''}`; desc.textContent=ep.description||'';
      wireSources(audio, ep); window.__pp.initOne(player); return node;
    }

    function loadMore(){
      const start=S.page*PAGE_SIZE; const end=Math.min(start+PAGE_SIZE, S._rest.length);
      const items=S._rest.slice(start,end); items.forEach(ep=>list.appendChild(renderCard(ep))); S.page++;
      count.textContent=`显示 ${Math.min(end, S._rest.length)}/${S._rest.length} 期`;
      if(end>=S._rest.length){ more.disabled=true; more.textContent='没有更多了'; } else { more.disabled=false; more.textContent='加载更多'; }
      tryAttachBack();
    }

    async function init(){
      try{ const res=await fetch(DATA,{cache:'no-store'}); const data=await res.json(); const eps=Array.isArray(data.episodes)?data.episodes:[]; S.raw=eps; buildChips(); apply(); }
      catch(e){ console.error(e); }
    }

    more.addEventListener('click', loadMore);
    q.addEventListener('input', e => { S.q=e.target.value; apply(); });

    // 播放保护：把当前播放移到 dock，重绘后尝试放回
    const dock=document.getElementById('dock');
    function preserveIfPlaying(){ const playing=Array.from(document.querySelectorAll('audio')).find(a=>!a.paused&&!a.ended&&a.readyState>0); if(!playing) return; const player=playing.closest('[data-player]'); const article=playing.closest('article'); S.preservedId=article?.dataset.id||null; if(player&&dock){ dock.innerHTML=''; dock.appendChild(player); dock.hidden=false; } }
    function tryAttachBack(){ if(!S.preservedId) return; const host=document.querySelector(`article[data-id="${S.preservedId}"] [data-player]`); if(host&&dock.firstElementChild){ host.replaceWith(dock.firstElementChild); dock.hidden=true; S.preservedId=null; } }

    init();
  })();
  </script>
</body>
</html>
