<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>企业培训播客</title>
  <meta name="description" content="企业培训播客：搜索、分类、当期内容、自定义音频播放器、往期回顾。" />
  <link rel="icon" href="/favicon.ico" />
  <style>
    :root{
      --bg:#f5f6f8;--surface:#ffffff;--ink:#0b1220;--muted:#6b7280;--line:#e6e8ee;--brand:#111827;--pill:#eef2f7;--pill-active:#111827;--pill-active-ink:#ffffff;--badge:#111827;--accent:#111827;
      --radius-xl:24px;--radius-lg:16px;--radius-md:12px;--shadow:0 4px 16px rgba(17,24,39,.08);
      --maxw:960px
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; color:var(--ink);background:var(--bg)}
    a{color:var(--accent);text-decoration:none}

    header{position:sticky;top:0;z-index:20;background:rgba(245,246,248,.9);backdrop-filter:saturate(1.2) blur(8px);border-bottom:1px solid var(--line)}
    .bar{max-width:var(--maxw);margin:0 auto;padding:14px 16px;text-align:center;font-weight:700}

    main{max-width:var(--maxw);margin:0 auto;padding:16px}

    /* 搜索 */
    .search-wrap{background:var(--surface);border:1px solid var(--line);border-radius:999px;padding:10px 14px;display:flex;gap:10px;align-items:center;box-shadow:var(--shadow)}
    .search-wrap input{border:none;outline:none;flex:1;font-size:16px;background:transparent}
    .search-icon{width:18px;height:18px;opacity:.6}

    /* 分类 chips */
    .filters{margin:14px 0 10px}
    .filter-title{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:14px;margin-bottom:8px}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{appearance:none;border:none;cursor:pointer;padding:8px 12px;border-radius:999px;background:var(--pill);color:#111827;font-weight:600;font-size:14px}
    .chip.active{background:var(--pill-active);color:var(--pill-active-ink)}

    /* 分段标题 */
    .section{margin:14px 0 10px;font-weight:800}

    /* 大卡片（本期内容） */
    .feature{background:var(--surface);border:1px solid var(--line);border-radius:var(--radius-xl);overflow:hidden;box-shadow:var(--shadow)}
    .feature .cover{position:relative}
    .feature .img{width:100%;aspect-ratio:16/9;object-fit:cover;display:block}
    .badge{position:absolute;left:12px;top:12px;background:var(--badge);color:#fff;border-radius:999px;padding:6px 10px;font-size:12px;font-weight:700}
    .tag{position:absolute;right:12px;top:12px;background:rgba(17,24,39,.85);color:#fff;border-radius:999px;padding:6px 10px;font-size:12px;font-weight:700}
    .pad{padding:14px}
    .title{margin:0 0 8px;font-size:18px;line-height:1.35}
    .meta{display:flex;gap:14px;align-items:center;color:var(--muted);font-size:14px;margin-bottom:10px}
    .desc{margin:0 0 12px;color:#374151;line-height:1.6}

    /* 小卡片（往期） */
    .list{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:700px){.list{grid-template-columns:1fr 1fr}}
    .card{background:var(--surface);border:1px solid var(--line);border-radius:var(--radius-lg);overflow:hidden;box-shadow:var(--shadow);display:flex;flex-direction:column}
    .card .cover{position:relative}
    .card .img{width:100%;aspect-ratio:16/9;object-fit:cover;display:block}
    .card .pad{padding:12px}

    /* 自定义播放器 */
    .player{background:#fafbff;border:1px solid var(--line);border-radius:12px;padding:10px}
    .controls{display:flex;justify-content:center;align-items:center;gap:12px;margin:8px 0}
    .btn{appearance:none;border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 12px;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:default}
    .btn.round{border-radius:14px}
    .time{display:flex;justify-content:space-between;font-size:12px;color:var(--muted)}
    .range{width:100%}

    .load{display:flex;justify-content:center;margin:16px 0}
    .load .btn{padding:10px 14px;border-radius:999px}

    footer{color:var(--muted);text-align:center;margin:22px 0 30px}
  </style>
</head>
<body>
  <header>
    <div class="bar">企业培训播客</div>
  </header>

  <main>
    <!-- 搜索 -->
    <div class="search-wrap" role="search">
      <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
      <input id="q" type="search" placeholder="搜索播客内容…" aria-label="搜索播客" />
    </div>

    <!-- 分类 -->
    <div class="filters">
      <div class="filter-title">🧭 分类筛选</div>
      <div id="chips" class="chips"></div>
    </div>

    <div class="section">本期内容</div>
    <section id="feature"></section>

    <div class="section" style="display:flex;justify-content:space-between;align-items:center">
      <span>往期回顾</span>
      <small id="count" style="color:var(--muted)"></small>
    </div>
    <section id="list" class="list"></section>
    <div class="load"><button id="more" class="btn">加载更多</button></div>
  </main>

  <footer>© <span id="year"></span> 企业培训播客 · Cloudflare Pages</footer>

  <template id="cardTpl">
    <article class="card">
      <div class="cover">
        <img class="img" alt="" />
        <span class="tag" hidden></span>
      </div>
      <div class="pad">
        <h3 class="title"></h3>
        <div class="meta"></div>
        <p class="desc"></p>
        <div class="player" data-player>
          <audio preload="metadata"></audio>
          <input class="range" type="range" min="0" max="100" value="0" step="0.1" aria-label="进度" />
          <div class="controls">
            <button class="btn" data-skip="-15" title="后退15秒">⏮︎</button>
            <button class="btn round" data-toggle title="播放/暂停">⏯︎</button>
            <button class="btn" data-skip="30" title="快进30秒">⏭︎</button>
          </div>
          <div class="time"><span data-cur>00:00</span><span data-dur>--:--</span></div>
        </div>
      </div>
    </article>
  </template>

  <template id="featureTpl">
    <article class="feature">
      <div class="cover">
        <img class="img" alt="" />
        <span class="badge">最新期</span>
        <span class="tag" hidden></span>
      </div>
      <div class="pad">
        <h3 class="title"></h3>
        <div class="meta"></div>
        <p class="desc"></p>
        <div class="player" data-player>
          <audio preload="metadata"></audio>
          <input class="range" type="range" min="0" max="100" value="0" step="0.1" aria-label="进度" />
          <div class="controls">
            <button class="btn" data-skip="-15" title="后退15秒">⏮︎</button>
            <button class="btn round" data-toggle title="播放/暂停">⏯︎</button>
            <button class="btn" data-skip="30" title="快进30秒">⏭︎</button>
          </div>
          <div class="time"><span data-cur>00:00</span><span data-dur>--:--</span></div>
        </div>
      </div>
    </article>
  </template>

  <script>
  ;(() => {
    const DATA = '/data/episodes.json';
    const PAGE_SIZE = 6;

    const el = sel => document.querySelector(sel);
    const feature = el('#feature');
    const list = el('#list');
    const more = el('#more');
    const chips = el('#chips');
    const q = el('#q');
    const count = el('#count');
    el('#year').textContent = new Date().getFullYear();

    const S = { raw: [], filtered: [], page: 0, tag: '全部', q: '' };

    const fmtDate = s => {
      if(!s) return '';
      const d = new Date(s);
      if(Number.isNaN(d)) return s;
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    };
    const fmtDur = sec => {
      if(sec==null) return '';
      const t = Math.max(0, Math.floor(sec));
      const m = Math.floor(t/60), r = t%60;
      const h = Math.floor(m/60); const mm = m%60;
      return h>0? `${h}:${String(mm).padStart(2,'0')}:${String(r).padStart(2,'0')}` : `${mm}:${String(r).padStart(2,'0')}`;
    };

    function mountPlayer(root){
      const audio = root.querySelector('audio');
      const range = root.querySelector('.range');
      const cur = root.querySelector('[data-cur]');
      const dur = root.querySelector('[data-dur]');
      const toggle = root.querySelector('[data-toggle]');
      const skips = root.querySelectorAll('[data-skip]');

      function toTime(t){
        const s = Math.floor(t);
        const m = Math.floor(s/60); const r = s%60; return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`;
      }

      audio.addEventListener('loadedmetadata', () => {
        dur.textContent = toTime(audio.duration || 0);
      });

      audio.addEventListener('timeupdate', () => {
        if(!isFinite(audio.duration)) return;
        const p = (audio.currentTime / audio.duration) * 100;
        range.value = p || 0;
        cur.textContent = toTime(audio.currentTime);
      });

      range.addEventListener('input', () => {
        if(isFinite(audio.duration)){
          audio.currentTime = (range.value / 100) * audio.duration;
        }
      });

      toggle.addEventListener('click', () => {
        // 暂停其它播放
        document.querySelectorAll('audio').forEach(a => { if(a!==audio) a.pause(); });
        audio.paused ? audio.play() : audio.pause();
      });

      skips.forEach(b => b.addEventListener('click', () => {
        const d = Number(b.dataset.skip||0);
        audio.currentTime = Math.max(0, Math.min((audio.currentTime||0)+d, audio.duration||Infinity));
      }));
    }

    function buildChips(){
      const set = new Set(['全部']);
      S.raw.forEach(e => (e.tags||[]).forEach(t => set.add(t)));
      chips.innerHTML = '';
      [...set].forEach(name => {
        const btn = document.createElement('button');
        btn.className = 'chip' + (name===S.tag?' active':'');
        btn.textContent = name;
        btn.addEventListener('click', () => { S.tag = name; apply(); });
        chips.appendChild(btn);
      });
    }

    function apply(){
      // 过滤
      const qtext = S.q.trim().toLowerCase();
      S.filtered = S.raw.filter(e => {
        const okTag = (S.tag==='全部') || (e.tags||[]).includes(S.tag);
        const inText = !qtext || [e.title, e.description, ...(e.tags||[])].join(' ').toLowerCase().includes(qtext);
        return okTag && inText;
      });
      // 按时间降序
      S.filtered.sort((a,b)=> new Date(b.date||0) - new Date(a.date||0));
      S.page = 0;
      render();
    }

    function render(){
      // 本期（第一条）
      feature.innerHTML = '';
      list.innerHTML = '';
      const total = S.filtered.length;
      if(total === 0){ count.textContent = '显示 0/0 期'; more.disabled = true; return; }

      const first = S.filtered[0];
      feature.appendChild(renderFeature(first));

      // 往期分页
      const rest = S.filtered.slice(1);
      S._rest = rest; // 保存供“加载更多”使用
      count.textContent = `显示 ${Math.min(S.page*PAGE_SIZE + Math.min(PAGE_SIZE, rest.length), rest.length)}/${rest.length} 期`;
      more.disabled = rest.length === 0;
      S.page = 0;
      loadMore();
    }

    function renderFeature(ep){
      const t = document.getElementById('featureTpl');
      const node = t.content.cloneNode(true);
      const img = node.querySelector('.img');
      const tag = node.querySelector('.tag');
      const title = node.querySelector('.title');
      const meta = node.querySelector('.meta');
      const desc = node.querySelector('.desc');
      const audio = node.querySelector('audio');

      img.src = ep.cover || '';
      img.alt = ep.title || '';
      if(ep.tags && ep.tags[0]){ tag.hidden = false; tag.textContent = ep.tags[0]; }
      title.textContent = ep.title || '未命名节目';
      const date = fmtDate(ep.date);
      const dur = fmtDur(ep.duration);
      meta.textContent = `${date?date:''}${date&&dur?' · ':''}${dur?dur:''}`;
      desc.textContent = ep.description || '';
      audio.src = ep.audio || '';

      setTimeout(()=> mountPlayer(node.querySelector('[data-player]')));
      return node;
    }

    function renderCard(ep){
      const t = document.getElementById('cardTpl');
      const node = t.content.cloneNode(true);
      const img = node.querySelector('.img');
      const tag = node.querySelector('.tag');
      const title = node.querySelector('.title');
      const meta = node.querySelector('.meta');
      const desc = node.querySelector('.desc');
      const audio = node.querySelector('audio');
      img.src = ep.cover || '';
      img.alt = ep.title || '';
      if(ep.tags && ep.tags[0]){ tag.hidden = false; tag.textContent = ep.tags[0]; }
      title.textContent = ep.title || '未命名节目';
      const date = fmtDate(ep.date);
      const dur = fmtDur(ep.duration);
      meta.textContent = `${date?date:''}${date&&dur?' · ':''}${dur?dur:''}`;
      desc.textContent = ep.description || '';
      audio.src = ep.audio || '';
      setTimeout(()=> mountPlayer(node.querySelector('[data-player]')));
      return node;
    }

    function loadMore(){
      const start = S.page * PAGE_SIZE;
      const end = Math.min(start + PAGE_SIZE, S._rest.length);
      const items = S._rest.slice(start, end);
      items.forEach(ep => list.appendChild(renderCard(ep)));
      S.page++;
      count.textContent = `显示 ${Math.min(end, S._rest.length)}/${S._rest.length} 期`;
      if(end >= S._rest.length){ more.disabled = true; more.textContent = '没有更多了'; }
      else { more.disabled = false; more.textContent = '加载更多'; }
    }

    async function init(){
      try{
        const res = await fetch(DATA, {cache:'no-store'});
        const data = await res.json();
        const eps = Array.isArray(data.episodes) ? data.episodes : [];
        S.raw = eps;
        buildChips();
        apply();
      }catch(e){
        console.error(e);
      }
    }

    more.addEventListener('click', loadMore);
    q.addEventListener('input', e => { S.q = e.target.value; apply(); });

    init();
  })();
  </script>
</body>
</html>
